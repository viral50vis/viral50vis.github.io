/*! viral-50 v0.0.1 | (c) 2020 Erik Båvenstrand | MIT License | https://github.com/ErikBavenstrand/DH2321-Spotify-Project */
var selectedSongs=[],globalSelected=!1,songToColorMap={},songColors=["#40c990","#845f80","#ee840e"],usedSongColors=[];songColors.forEach((function(){usedSongColors.push(!1)}));var invertChip=[!1,!0,!1,!0,!1,!0],lastDataWeek=0;function addCountryToDetailView(e){addCountryToWeeklySongs(e),addCountryToLineChart(e),addCountryLegendChip(e),generateAttrBarChart()}function removeCountryFromDetailView(e){removeCountryFromWeeklySongs(e),removeCountryFromLineChart(e),removeCountryLegendChip(e),dehighlight(),generateAttrBarChart()}function changeWeekDetailView(){selectedCountries.forEach((function(e){changeWeeklySongsWeek(e)})),isInDetailView&&changeLineChartWeek(),generateAttrBarChart(),!isInDetailView&&tooltipRecent&&showCountryTooltip(tooltipCC)}function addCountryToWeeklySongs(e){var t=d3.select("#weekly-songs-list");t.append("li").attr("id","weekly-songs-"+e).append("div").attr("id","weekly-songs-div-"+e).data([e]).text((function(){return countryCCJSON[e]})).on("click",(function(e){t.selectAll("div").classed("active",!1),d3.select(this).classed("active",!0),d3.selectAll(".song-entry-wrapper").each((function(e){var t=JSON.stringify(e);selectedSongs.includes(t)&&d3.select(this).classed("selected-song",!0).insert("span",":first-child").attr("class","before-selected-song").style("background-color",getSongColor(t))})),3===selectedSongs.length&&(d3.selectAll(".song-entry-wrapper").each((function(){d3.select(this.parentNode).classed("noSelect",!0)})),d3.selectAll(".selected-song").each((function(){d3.select(this.parentNode).classed("noSelect",!1)}))),d3.selectAll(".weekly-song-list-wrapper").classed("weekly-song-list-wrapper-hidden",!0),d3.select("#weekly-song-tab-"+e).classed("weekly-song-list-wrapper-hidden",!1)})),d3.select("#weekly-songs-list-window").append("div").classed("weekly-song-list-wrapper",!0).classed("weekly-song-list-wrapper-hidden",!0).attr("id","weekly-song-tab-"+e).append("div").classed("weekly-song-list",!0).append("ol").attr("id","weekly-song-list-ul-"+e),1===t.selectAll("li").size()&&(d3.select("#weekly-songs-div-"+e).classed("active",!0),d3.select("#weekly-song-tab-"+e).classed("weekly-song-list-wrapper-hidden",!1)),changeWeeklySongsWeek(e)}function removeCountryFromWeeklySongs(e){var t=d3.select("#weekly-songs-list");d3.select("#weekly-songs-"+e).remove(),d3.select("#weekly-song-tab-"+e).remove();var n=!1;t.selectAll("div").each((function(){d3.select(this).classed("active")&&(n=!0)})),selectedCountries.length>0&&(n||(t.select("div").classed("active",!0),d3.select("#weekly-songs-list-window").select("div").classed("weekly-song-list-wrapper-hidden",!1)))}function changeWeeklySongsWeek(e){if(dataWeek!=lastDataWeek&&(lastDataWeek=dataWeek),d3.select("#weekly-song-list-ul-"+e).selectAll("li").remove(),data_songs[dataWeek][e]){var t=d3.select("#weekly-song-list-ul-"+e);t.selectAll("li").data(data_songs[dataWeek][e]).enter().append("li").append("div").classed("song-entry-wrapper",!0).each((function(e){var t=JSON.stringify(e);selectedSongs.includes(t)&&(d3.select(this).select("span").remove(),d3.select(this).classed("selected-song",!0).insert("span",":first-child").attr("class","before-selected-song").style("background-color",getSongColor(t)))})).on("mouseover",(function(e){var t=JSON.stringify(e);selectedSongs.includes(t)&&highlight(getStyleFriendlySongString(t))})).on("mouseout",(function(){dehighlight()})).on("click",(function(e){var t=JSON.stringify(e);selectedSongs.includes(t)?(deselectSong(e),dehighlight()):selectedSongs.length<3&&(getSongColor(t),selectedSongs.push(t),addSongLegendChip(e),d3.select(this).classed("selected-song",!0),generateAttrBarChart(),highlight(getStyleFriendlySongString(t))),d3.select(this).select("span").remove(),selectedSongs.includes(t)&&d3.select(this).insert("span",":first-child").attr("class","before-selected-song").style("background-color",getSongColor(t)),d3.select("#weekly-songs-selected").text((function(){return"("+selectedSongs.length+"/3"})),3===selectedSongs.length?(d3.selectAll(".song-entry-wrapper").each((function(){d3.select(this.parentNode).classed("noSelect",!0)})),d3.selectAll(".selected-song").each((function(){d3.select(this.parentNode).classed("noSelect",!1)}))):d3.selectAll(".song-entry-wrapper").each((function(){d3.select(this.parentNode).classed("noSelect",!1)}))})).append("div").classed("song-name",!0).text((function(t){return pos=data_songs[dataWeek][e].map((function(e){return e["Track Name"]})).indexOf(t["Track Name"])+1,pos+". "+t["Track Name"]})),t.selectAll(".song-entry-wrapper").data(data_songs[dataWeek][e]).append("div").classed("artist-name",!0).text((function(e){return e.Artist})),songLink=t.selectAll(".song-entry-wrapper").data(data_songs[dataWeek][e]).append("a").classed("spotify-link",!0).text("Spotify").attr("href",(function(e){return e.URL})).attr("target","_blank"),songLink.append("i").attr("class","fas fa-external-link-alt"),3===selectedSongs.length?(d3.selectAll(".song-entry-wrapper").each((function(){d3.select(this.parentNode).classed("noSelect",!0)})),d3.selectAll(".selected-song").each((function(){d3.select(this.parentNode).classed("noSelect",!1)}))):d3.selectAll(".song-entry-wrapper").each((function(){d3.select(this.parentNode).classed("noSelect",!1)}))}}function deselectSong(e){var t=JSON.stringify(e);removeSongLegendChip(t),d3.selectAll(".song-entry-wrapper").filter((function(e){return JSON.stringify(e)===t})).classed("selected-song",!1).selectAll("span").remove(),d3.selectAll(".selected-song").each((function(e){JSON.stringify(e)===t&&d3.select(this).classed("selected-song",!1).selectAll("span").remove()})),selectedSongs.splice(selectedSongs.indexOf(t),1),clearSongColor(t),generateAttrBarChart(),d3.select("#weekly-songs-selected").text((function(){return"("+selectedSongs.length+"/3"}))}function deselectCountry(e){selectedCountries.splice(selectedCountries.indexOf(e),1),d3.select("#country-list-"+e).style("color",null),removeCountryFromDetailView(e),0==selectedCountries.length&&zoomOutCountryHideDetail(e)}function clearSelectedSongs(){selectedSongs=[],songToColorMap={},usedSongColors=[],songColors.forEach((function(){usedSongColors.push(!1)})),d3.selectAll(".song-chip-bg").remove(),d3.select(".weekly-song-list").select("ol").selectAll("li").classed("noSelect",!1),d3.select("#weekly-songs-selected").text((function(){return"("+selectedSongs.length+"/3"}))}function getSongColor(e){return void 0!==songToColorMap[e]?songColors[songToColorMap[e]]:(usedSongColors.some((function(e,n){return e||(t=n),!e})),usedSongColors[t]=!0,songToColorMap[e]=t,songColors[t]);var t}function clearSongColor(e){usedSongColors[songToColorMap[e]]=!1,delete songToColorMap[e]}function generateAttrBarChart(){var e=["danceability","energy","speechiness","acousticness","instrumentalness","liveness","valence"],t=selectedCountries.filter((function(e){return null!=data_attrs[dataWeek][e]})),n=e.length,l=t.length+selectedSongs.length+globalLine.length,s=d3.range(l).map((function(l){return d3.range(n).map((function(n){var s=t.length,o=selectedSongs.length;return l<t.length?data_attrs[dataWeek][t[l]][e[n]]:l-s<o?JSON.parse(selectedSongs[l-s])[e[n]]:data_attrs[dataWeek].GLO[e[n]]}))})),o=20,r=30,a=30,c=40,i=d3.select("#attr-barchart-wrapper").node().getBoundingClientRect().width-c-r,d=d3.select("#attr-barchart-wrapper").node().getBoundingClientRect().height-o-a,g=d3.scaleLinear().domain([0,1]).range([d,0]),h=d3.scaleBand().domain(d3.range(n)).range([0,i],.2),u=d3.scaleBand().domain(d3.range(l)).range([0,h.bandwidth()-30]),p=t.length,f=selectedSongs.length;d3.select("#attr-barchart-wrapper").selectAll("svg").remove();var y=d3.select("#attr-barchart-wrapper").append("svg").attr("width",i+c+r).attr("height",d+o+a).append("g").attr("transform","translate("+c+","+o+")");y.append("g").call(d3.axisLeft(g)).classed("y axis",!0),y.selectAll("g.tick").filter((function(t){if(e.indexOf(d3.select(this).text())>-1)return!0})).select("text").classed("attribute-text",!0),y.selectAll(".y.axis > .tick").each((function(){var e=d3.create("svg:line").attr("class","y-gridline").attr("x1",0).attr("x2",innerWidth);this.append(e.node())}));var S=d3.local();y.append("g").selectAll("g").data(s).enter().append("g").attr("class",(function(e,t){if(t>=p){if(globalSelected&&t===s.length-1)return"";songAttrs=selectedSongs.map((function(e){return attrArray=[],e=JSON.parse(e),Object.keys(e).forEach((function(t){-1!==attributes.indexOf(t)&&attrArray.push(e[t])})),attrArray}));for(var n=-1,l=0;l<songAttrs.length;l++)filtered=songAttrs[l].filter((function(t,n){return t==e[n]})),songAttrs[l].length==filtered.length&&(n=l);var o=songToColorMap[selectedSongs[n]];return invertChip[3+o]?"song-bar-container song-bar-inverted":"song-bar-container song-bar-normal"}})).style("fill",(function(e,t){return t<p?S.set(this,selectedCountries[t]):t-p<f?S.set(this,getStyleFriendlySongString(selectedSongs[t-p])):S.set(this,"GLO"),(function(e){if(e<p){var t=chartCountryLines[e].color;return countryColors[t]}return e-p<f?getSongColor(selectedSongs[e-p]):"#fff"})(t)})).attr("transform",(function(e,t){return"translate("+u(t)+",0)"})).selectAll("rect").data((function(e){return e})).enter().append("rect").attr("class",(function(e){return"chart-element chart-nonline chart-element-"+S.get(this)})).attr("width",u.bandwidth()).attr("height",(function(e){return g(1-e)})).attr("x",(function(e,t){return h(t)})).attr("y",(function(e){return d-g(1-e)})),y.selectAll(".song-bar-container").selectAll("span").data((function(e){return e})).enter().append("foreignObject").classed("song-bar-stripes",!0).attr("width",u.bandwidth()).attr("height",(function(e){return g(1-e)})).attr("x",(function(e,t){return h(t)})).attr("y",(function(e){return d-g(1-e)})),y.append("g").attr("transform","translate(-15,"+d+")").call(d3.axisBottom(h).tickFormat((function(t){return e[t][0].toUpperCase()+e[t].slice(1)}))).classed("x axis",!0)}function toggleGlobalLineDetailView(){toggleGlobalLine(),globalSelected=!globalSelected,generateAttrBarChart(),globalSelected?highlight("GLO"):dehighlight()}d3.select("#legend-return-label").insert("i",":first-child").attr("class","fas fa-chevron-left"),d3.select("#close-detail").on("click",(function(e){var t=selectedCountries.slice(0);t.forEach((function(e){selectedCountries.splice(selectedCountries.indexOf(e),1),d3.select("#country-list-"+e).style("color",null),removeCountryFromDetailView(e),clearSelectedSongs(),checkToggleListClickability()})),zoomOutCountryHideDetail(t[0])}));var globalContainer=d3.select(".Detail__legend-to-plots").select("#global-checkbox").classed("global-checkbox-div",!0).classed("chart-element",!0).classed("chart-element-GLO",!0).on("mouseover",(function(){globalSelected&&highlight("GLO")})).on("mouseout",(function(){dehighlight()})).append("label").attr("for","globalCheck").attr("class","mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect"),globalCheckbox=globalContainer.append("input").attr("type","checkbox").attr("id","globalCheck").classed("mdl-checkbox__input",!0).on("change",toggleGlobalLineDetailView);function addCountryLegendChip(e){var t=countryColors[chartCountryLines[selectedCountries.indexOf(e)].color],n=invertChip[countryColors.indexOf(t)],l=d3.select("#country-legend-wrapper").append("div").attr("id","legend-chip-"+e).classed("legend-chip",!0).classed("chip-inverted",n).classed("country-chip",!0).classed("chart-element",!0).classed("chart-element-"+e,!0).style("background",t).on("mouseover",(function(){highlight(e)})).on("mouseout",(function(){dehighlight()}));l.append("div").classed("legend-chip-label",!0).text(countryCCJSON[e]),l.append("div").classed("legend-chip-remove",!0).classed("chip-remove-inverted",n).text("×").on("click",(function(){deselectCountry(e)}))}function removeCountryLegendChip(e){d3.select("#legend-chip-"+e).remove(),d3.select("#country-list-ul").selectAll("li").classed("noSelect",!1)}function addSongLegendChip(e){var t=JSON.stringify(e),n=getSongColor(t),l=invertChip[songToColorMap[t]+3],s=d3.select("#song-legend-wrapper").append("div").attr("id","legend-chip-"+getStyleFriendlySongString(t)).style("background",n).classed("chart-element",!0).classed("chart-element-"+getStyleFriendlySongString(t),!0).classed("song-chip-bg",!0).append("div").classed("legend-chip",!0).classed("chip-normal",!l).classed("chip-inverted",l).classed("song-chip",!0).on("mouseover",(function(){highlight(getStyleFriendlySongString(t))})).on("mouseout",(function(){dehighlight()}));s.append("div").classed("legend-chip-label",!0).text(e["Track Name"]),s.append("div").classed("legend-chip-remove",!0).classed("chip-remove-inverted",l).text("×").on("click",(function(){deselectSong(e)}))}function removeSongLegendChip(e){d3.select("#legend-chip-"+getStyleFriendlySongString(e)).remove(),d3.select(".weekly-song-list").select("ol").selectAll("li").classed("noSelect",!1)}function getStyleFriendlySongString(e){for(var t="",n=0;n<e.length;++n){var l=e.charAt(n);l.match(/^[0-9A-Za-z]+$/)&&(t+=l)}return t}function highlight(e){d3.selectAll(".chart-dot").style("opacity",(function(){var t=d3.select(this).classed("focus")?.8:.5;return d3.select(this).classed("chart-element-"+e)?t:.1}));var t=d3.selectAll(".chart-element");t.filter((function(){return!d3.select(this).classed("chart-element-"+e)})).style("opacity",.2).each((function(){d3.select(this.parentNode).selectAll(".song-bar-stripes").style("opacity",.2)})),t.filter((function(){return d3.select(this).classed("chart-element-"+e)})).style("opacity",1).each((function(){d3.select(this.parentNode).selectAll(".song-bar-stripes").style("opacity",1)}))}function dehighlight(){d3.selectAll(".chart-element").style("opacity",1),d3.selectAll(".chart-dot.focus").style("opacity",.8),d3.selectAll(".chart-dot.nonfocus").style("opacity",.5),d3.selectAll(".song-bar-stripes").style("opacity",1)}globalContainer.append("span").classed("global-checkbox-label",!0).classed("mdl-checkbox__label",!0).text("Global");